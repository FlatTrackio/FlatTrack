stages:
  - lint
  - test
  - build
  - post-build
  - pages

include:
  template: Dependency-Scanning.gitlab-ci.yml

variables:
  ARCH_DEFAULT: "amd64"
  ARCHES: amd64 arm64 arm
  PLATFORMS: linux/amd64,linux/arm64,linux/arm/v7
  APP_BUILD_VERSION: 0.0.0
  APP_BUILD_MODE: development
  POSTGRES_DB: flattrack
  POSTGRES_USER: flattrack
  POSTGRES_PASSWORD: flattrack
  REGISTRIES: "$CI_REGISTRY docker.io"
  IMAGE_GOLANG_ALPINE: docker.io/golang:1.17.0-alpine3.14
  IMAGE_NODE_ALPINE: docker.io/node:15.14.0-alpine3.13
  IMAGE_ALPINE: docker.io/alpine:3.14
  IMAGE_DOCKER: docker.io/docker:20.10.6
  IMAGE_FIRN: registry.gitlab.com/bobymcbobs/container-images/firn:0.0.13-alpha.0

.container-build-pre-script: &container-build-pre-script |
  set -x
  img login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
  img login docker.io -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN

.container-build-taggable-name: &container-build-taggable-name |
  set -x
  echo "Commit made on '${CI_COMMIT_TIMESTAMP}'"
  COMMIT_HASH="$CI_COMMIT_SHORT_SHA"
  BUILD_DATE=$(date --date="${CI_COMMIT_TIMESTAMP//[T+]/ }" '+%Y.%m.%d.%H%M')
  if [[ -z "$CI_COMMIT_TAG" ]]; then
    PRINTABLE_COMMIT_HASH="-$COMMIT_HASH"
  fi
  if [[ ! "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]] && [[ -z "$CI_COMMIT_TAG" ]]; then
    BRANCH_NAME="-$CI_COMMIT_BRANCH"
  fi
  PRINT_ARCH="$(echo $ARCH | tr -d '/')"
  PROJECT_PATH=$(echo $CI_PROJECT_PATH | tr '[:upper:]' '[:lower:]')

.container-pre-build-release-version: &container-pre-build-release-version |
  if [[ ! -z "$CI_COMMIT_TAG" ]]; then
    export APP_BUILD_VERSION="$CI_COMMIT_TAG"
    export APP_BUILD_MODE=production
    for reg in $REGISTRIES; do
      export CONTAINER_RELEASE_DESTINATIONS_WITH_TAGS="$CONTAINER_RELEASE_DESTINATIONS_WITH_TAGS -t $reg/$PROJECT_PATH:$APP_BUILD_VERSION"
      export CONTAINER_RELEASE_DESTINATIONS="$CONTAINER_RELEASE_DESTINATIONS $reg/$PROJECT_PATH:$APP_BUILD_VERSION"
    done
  fi
  for reg in $REGISTRIES; do
    export CONTAINER_DESTINATIONS_WITH_TAGS="$CONTAINER_DESTINATIONS_WITH_TAGS -t $reg/$PROJECT_PATH:latest$BRANCH_NAME"
    export CONTAINER_DESTINATIONS="$CONTAINER_DESTINATIONS $reg/$PROJECT_PATH:latest$BRANCH_NAME"
  done

.container-build: &container-build |
  img build \
    -f $CI_PROJECT_DIR/build/Dockerfile \
    $CONTAINER_DESTINATIONS_WITH_TAGS \
    $CONTAINER_RELEASE_DESTINATIONS_WITHTAGS \
    --platform $PLATFORMS \
    --build-arg GOARCH="$ARCH" \
    --build-arg AppBuildVersion="$APP_BUILD_VERSION" \
    --build-arg AppBuildDate="$BUILD_DATE" \
    --build-arg AppBuildHash="$COMMIT_HASH" \
    --build-arg AppBuildMode="$APP_BUILD_MODE" \
    $CI_PROJECT_DIR

  for TAG in $CONTAINER_RELEASE_DESTINATIONS $CONTAINER_DESTINATIONS; do
    img push $TAG
  done

.zip-prepare: &zip-prepare |
  export RELEASE_FOLDER_NAME="flattrack$BRANCH_NAME$PRINTABLE_COMMIT_HASH"
  mkdir -p $RELEASE_FOLDER_NAME

build-containers:
  stage: build
  image:
    name: $IMAGE_ALPINE
    entrypoint: [""]
  retry: 2
  before_script:
    - apk add img
    - *container-build-pre-script
    - *container-build-taggable-name
    - *container-pre-build-release-version
  script:
    - *container-build

build-helm-chart:
  stage: build
  image: $IMAGE_ALPINE
  variables:
    HELM_LINK: https://get.helm.sh/helm-v3.4.0-linux-amd64.tar.gz
    HELM_HASH: 270acb0f085b72ec28aee894c7443739271758010323d72ced0e92cd2c96ffdb
  allow_failure: true
  before_script:
    - *container-build-taggable-name
    - apk add curl
    - curl -L -o helm.tar.gz $HELM_LINK
    - |
        if [ ! $(sha256sum helm.tar.gz) = $HELM_HASH ]; then
          exit 1
        fi
    - cat helm.tar.gz | tar --directory /usr/local/bin --extract -xz --strip-components 1 linux-amd64/helm
  script:
    - helm package deployments/flattrack --destination .helm-root/helm/
    - helm repo index --url "https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}" .helm-root/
  artifacts:
    paths:
      - .helm-root
  only:
    - master

build-zip-frontend:
  stage: build
  retry: 2
  image: $IMAGE_NODE_ALPINE
  before_script:
    - *container-build-taggable-name
    - *container-pre-build-release-version
    - *zip-prepare
    - cd web
    - apk add --no-cache python2 make g++
    - npm i
  script:
    - ./node_modules/.bin/vue-cli-service build --dest $CI_PROJECT_DIR/$RELEASE_FOLDER_NAME/dist ./src/main.js
  only:
    - tags
    - master
  artifacts:
    expire_in: 1 day
    paths:
      - flattrack*/

build-zip-backend:
  stage: build
  retry: 2
  image: $IMAGE_GOLANG_ALPINE
  before_script:
    - *container-build-taggable-name
    - *container-pre-build-release-version
    - *zip-prepare
  script:
    - |
      AppBuildVersion="$APP_BUILD_VERSION"
      AppBuildHash="$COMMIT_HASH"
      AppBuildDate="$BUILD_DATE"
      AppBuildMode="$APP_BUILD_MODE"
      for ARCH in $ARCHES; do
        echo "Building backend for $ARCH";
        PRINTABLE_ARCH="-$ARCH"
        if [ $ARCH = $ARCH_DEFAULT ]; then
          PRINTABLE_ARCH=
        fi
        CGO_ENABLED=0 GOOS=linux GOARCH="$ARCH" go build \
          -a \
          -installsuffix cgo \
          -ldflags "-extldflags '-static' -s -w \
          -X gitlab.com/flattrack/flattrack/pkg/common.AppBuildVersion=$AppBuildVersion \
          -X gitlab.com/flattrack/flattrack/pkg/common.AppBuildHash=$AppBuildHash \
          -X gitlab.com/flattrack/flattrack/pkg/common.AppBuildDate=$AppBuildDate \
          -X gitlab.com/flattrack/flattrack/pkg/common.AppBuildMode=$AppBuildMode" \
          -o $RELEASE_FOLDER_NAME/flattrack$PRINTABLE_ARCH \
          main.go
      done
  only:
    - tags
    - master
  artifacts:
    expire_in: 1 day
    paths:
      - flattrack*

build-zip-copy-extras:
  stage: build
  retry: 2
  image: $IMAGE_ALPINE
  before_script:
    - *container-build-taggable-name
    - *container-pre-build-release-version
    - *zip-prepare
  script:
    - cp -r migrations $RELEASE_FOLDER_NAME/migrations
    - cp -r templates $RELEASE_FOLDER_NAME/templates
    - cp example.env $RELEASE_FOLDER_NAME
  only:
    - tags
    - master
  artifacts:
    expire_in: 1 day
    paths:
      - flattrack*

build-zip:
  stage: post-build
  retry: 2
  image: $IMAGE_ALPINE
  dependencies:
    - build-zip-frontend
    - build-zip-backend
    - build-zip-copy-extras
  before_script:
    - *container-build-taggable-name
    - *container-pre-build-release-version
    - *zip-prepare
  script:
    - tar cvf $RELEASE_FOLDER_NAME.tar.gz $RELEASE_FOLDER_NAME
  only:
    - tags
    - master
  artifacts:
    paths:
      - flattrack*.tar.gz

test_backend_e2e:
  stage: test
  image: $IMAGE_GOLANG_ALPINE
  variables:
    APP_DB_HOST: postgres
    CGO_ENABLED: "0"
  services:
    - postgres:12.2-alpine
  before_script:
    - apk add git gcc
    - go get github.com/onsi/ginkgo/ginkgo
    - go get github.com/onsi/gomega/...
    - go build -o flattrack main.go
    - ./flattrack &
  script:
    - ginkgo -r --randomizeAllSpecs --randomizeSuites --failOnPending --cover --trace --progress test/backend/e2e
    - pkill flattrack || true

spell_check:
  stage: lint
  image: $IMAGE_GOLANG_ALPINE
  allow_failure: true
  before_script:
    - go get -u github.com/client9/misspell/cmd/misspell
  script:
    - misspell -error src docs migrations pubic template k8s-manifests README*
    
lint_frontend:
  stage: lint
  image: $IMAGE_NODE_ALPINE
  allow_failure: true
  before_script:
    - cd web
    - apk add --no-cache python2
    - npm i
  script:
    - npm run lint

lint_backend:
  stage: lint
  image: $IMAGE_GOLANG_ALPINE
  allow_failure: true
  before_script:
    - apk add git gcc
    - go get -u golang.org/x/lint/golint
  script:
    - echo -e "GOLINT\n"
    - golint -set_exit_status ./...
    - echo -e "GOFMT\n"
    - gofmt -d .

lint_helm_chart:
  stage: lint
  image: $IMAGE_ALPINE
  variables:
    HELM_LINK: https://get.helm.sh/helm-v3.4.0-linux-amd64.tar.gz
    HELM_HASH: 270acb0f085b72ec28aee894c7443739271758010323d72ced0e92cd2c96ffdb
  allow_failure: true
  before_script:
    - apk add curl
    - curl -L -o helm.tar.gz $HELM_LINK
    - |
        if [ ! $(sha256sum helm.tar.gz) = $HELM_HASH ]; then
          exit 1
        fi
    - cat helm.tar.gz | tar --directory /usr/local/bin --extract -xz --strip-components 1 linux-amd64/helm
  script:
    - helm lint deployments/flattrack

pages:
  image:
    # use temporary firn container image instead of theiceshelf/firn image, until tagging is in CI
    name: $IMAGE_FIRN
    entrypoint: [""]
  stage: pages
  before_script:
    - cd docs
  script:
  - firn build
  - mv _firn/_site ../public
  - cp -r ../.helm-root/* ../public
  artifacts:
    paths:
    - public
  only:
    - master
