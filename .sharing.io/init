#!/bin/bash -x

#
# script for initialisation with https://github.com/sharingio/pair instances
#

if [ -f /var/run/secrets/kubernetes.io/serviceaccount/namespace ]; then
    kubectl create ns flattrack-dev

    echo "Installing Postgres"
    kubectl -n flattrack-dev apply -k deployments/k8s-manifests/development/postgres

    echo "Waiting for Postgres to be ready"
    kubectl -n flattrack-dev --for=condition=ready pod --selector=app=postgres --timeout=90s

    echo "Building and installing FlatTrack"
    echo "Starting Tilt"
    tmate -F -v -S $TMATE_SOCKET new-window -d -c "$PWD" -n tilt bash
    tmate -S $TMATE_SOCKET send-keys -t tilt "export DEFAULT_SUBDOMAIN_NAME=flattrack-dev && export FLATTRACK_DEV_HOSTNAME=\"$DEFAULT_SUBDOMAIN_NAME.$SHARINGIO_PAIR_BASE_DNS_NAME\"" Enter
    tmate -S $TMATE_SOCKET send-keys -t tilt "tilt up --host 0.0.0.0 --hud" Enter

    echo "Building Backend"
    tmate -F -v -S $TMATE_SOCKET new-window -d -c "$PWD" -n backend bash
    tmate -S $TMATE_SOCKET send-keys -t backend "CGO_ENABLED=0 go build -a -installsuffix cgo -ldflags \"-extldflags '-static' -s -w\" -o flattrack ./main.go" Enter

    echo "Building Frontend"
    tmate -F -v -S $TMATE_SOCKET new-window -d -c "$PWD/web" -n frontend bash
    tmate -S $TMATE_SOCKET send-keys -t frontend "npm i && npm run build" Enter
fi
